generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 Int      @id @default(autoincrement())
  email              String   @unique
  password           String
  phone              String   @unique
  role               UserRole @default(CLIENT)
  firstName          String
  lastName           String
  hashedRefreshToken String?

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cars            Car[]
  managedOrders   Order[]          @relation("ManagerOrders")
  mechanicOrders  Order[]          @relation("MechanicOrders")
  historyEntries  OrderHistory[]
  assignedTasks   Task[]
  notifications   Notification[]
  serviceRequests ServiceRequest[] @relation("ClientRequests")
}

model Car {
  id      Int    @id @default(autoincrement())
  brand   String
  model   String
  year    Int
  vin     String @unique
  plate   String @unique
  mileage Int    @default(0)
  color   String

  deletedAt DateTime?

  userId Int
  user   User @relation(fields: [userId], references: [id])

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  orders          Order[]
  serviceRequests ServiceRequest[]
}

model ServiceRequest {
  id          Int                  @id @default(autoincrement())
  clientId    Int
  client      User                 @relation("ClientRequests", fields: [clientId], references: [id])
  carId       Int
  car         Car                  @relation(fields: [carId], references: [id])
  reason      String
  description String?
  status      ServiceRequestStatus @default(NEW)

  orderId Int?   @unique
  order   Order? @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([status])
}

model Order {
  id          Int         @id @default(autoincrement())
  status      OrderStatus @default(CONFIRMED)
  mileage     Int
  description String?
  totalAmount Decimal     @default(0) @db.Decimal(10, 2)

  carId Int
  car   Car @relation(fields: [carId], references: [id])

  managerId Int?
  manager   User? @relation("ManagerOrders", fields: [managerId], references: [id])

  mechanicId Int?
  mechanic   User? @relation("MechanicOrders", fields: [mechanicId], references: [id])

  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deletedAt DateTime?

  history        OrderHistory[]
  items          OrderItem[]
  payments       Payment[]
  tasks          Task[]
  appointments   Appointment[]
  serviceRequest ServiceRequest?
}

model Appointment {
  id           Int               @id @default(autoincrement())
  orderId      Int
  order        Order             @relation(fields: [orderId], references: [id])
  scheduledAt  DateTime
  estimatedMin Int?
  status       AppointmentStatus @default(SCHEDULED)
  note         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scheduledAt])
  @@index([orderId])
  @@index([status])
}

model OrderItem {
  id      Int   @id @default(autoincrement())
  orderId Int
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  serviceId Int?
  service   Service? @relation(fields: [serviceId], references: [id])

  partId Int?
  part   Part? @relation(fields: [partId], references: [id])

  name     String
  quantity Int     @default(1)
  price    Decimal @db.Decimal(10, 2)
}

model Service {
  id          Int     @id @default(autoincrement())
  name        String
  price       Decimal @db.Decimal(10, 2)
  durationMin Int?

  deletedAt DateTime?

  orderItems OrderItem[]
}

model Part {
  id    Int     @id @default(autoincrement())
  name  String
  sku   String  @unique
  price Decimal @db.Decimal(10, 2)
  stock Int     @default(0)

  deletedAt DateTime?

  orderItems OrderItem[]
}

model Payment {
  id      Int           @id @default(autoincrement())
  orderId Int
  order   Order         @relation(fields: [orderId], references: [id])
  amount  Decimal       @db.Decimal(10, 2)
  method  PaymentMethod
  paidAt  DateTime      @default(now())
}

model Task {
  id      Int   @id @default(autoincrement())
  orderId Int
  order   Order @relation(fields: [orderId], references: [id])

  mechanicId Int
  mechanic   User @relation(fields: [mechanicId], references: [id])

  description String
  status      TaskStatus @default(PENDING)
  scheduledAt DateTime?
  createdAt   DateTime   @default(now())
}

model OrderHistory {
  id      Int   @id @default(autoincrement())
  orderId Int
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  changedById Int
  changedBy   User @relation(fields: [changedById], references: [id])

  action   String
  oldValue String?
  newValue String?
  comment  String?

  timestamp DateTime @default(now())
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      String
  orderId   Int?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead])
}

enum UserRole {
  ADMIN
  MANAGER
  MECHANIC
  CLIENT
}

enum OrderStatus {
  CONFIRMED
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  PAID
  CANCELLED
}

enum ServiceRequestStatus {
  NEW
  IN_REVIEW
  PROCESSED
  REJECTED
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  ARRIVED
  COMPLETED
  NO_SHOW
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  DONE
}
